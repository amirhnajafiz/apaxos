syntax = "proto3";
package transactions;

import "google/protobuf/empty.proto";

option go_package = "./transactions";

// creating rpc services for transactions and apaxos.
// the transactions service is for handling client-server calls.
service Transactions {
  rpc NewTransaction(Transaction) returns (TransactionResponse) {}
  rpc PrintBalance(google.protobuf.Empty) returns (PrintBalanceResponse) {}
  rpc PrintLogs(google.protobuf.Empty) returns (stream Block) {}
  rpc PrintDB(google.protobuf.Empty) returns (stream Block) {}
  rpc Performance(google.protobuf.Empty) returns (PerformanceResponse) {}
  rpc AggregatedBalance(
    AggregatedBalanceRequest
  ) returns (stream AggregatedBalanceResponse) {}
}
// the apaxos service is for handling internal node calls for
// performing paxos.
service Apaxos {
  rpc Propose(BallotNumber) returns (google.protobuf.Empty) {}
  rpc Promise(PromiseMessage) returns (google.protobuf.Empty) {}
  rpc Accept(AcceptMessage) returns (google.protobuf.Empty) {}
  rpc Accepted(google.protobuf.Empty) returns (google.protobuf.Empty) {}
  rpc Commit(google.protobuf.Empty) returns(google.protobuf.Empty) {}
  rpc Sync(stream SyncMessage) returns(google.protobuf.Empty) {}
}

// defining rpc messages, including block, transaction, and ballot number
message Block {
  string uid = 1;
  string node_id = 2;
  int64 sequence_number = 3;
  BallotNumber ballot_number = 4;
  repeated Transaction transactions = 5;
}

message Transaction {
  string uid = 1;
  string sender = 2;
  string reciever = 3;
  int64 amount = 4;
}

message BallotNumber {
  int64 number = 1;
  string node_id = 2;
}

message LastCommittedMessage {
  string uid = 1;
  string node_id = 2;
  int64 sequence_number = 3;
  BallotNumber ballot_number = 4;
}

message PromiseMessage {
  BallotNumber ballot_number = 1;
  LastCommittedMessage last_comitted_message = 2;
  repeated Block blocks = 3;
}

message AcceptMessage {
  BallotNumber ballot_number = 1;
  repeated Block blocks = 2;
}

message SyncMessage {
  string client = 1;
  int64 balance = 2;
}

// defining client messages requests-responses
message TransactionResponse {
  bool result = 1;
}

message PrintBalanceResponse {
  int64 balance = 1;
}

message PerformanceResponse {
  double throughput = 1;
  double latency = 2;
}

message AggregatedBalanceRequest {
  string client = 1;
}

message AggregatedBalanceResponse {
  string client = 1;
  string node_id = 2;
  int64 balance = 3;
}
